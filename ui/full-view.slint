import { Theme } from "theme.slint";

export enum MouseModeFull {
    select,
    drag,
}

export component FullView inherits TouchArea {
    in property <image> current_image;
    in property <int> curr_image_index;
    in property <string> curr_image_name;
    in property <int> total_images;
    in property <bool> timer_running: false;

    callback request_next_image();
    callback request_prev_image();
    callback rotate_plus_90();
    callback rotate_minus_90();
    callback exit_full_view();

    width: 100%;
    height: 100%;
    property <string> display_coords: "0, 0";
    property <float> zoom_scale: 1.0;
    property <length> last_coords_x;
    property <length> last_coords_y;

    property <MouseModeFull> mouse_mode_full: MouseModeFull.select;
    mouse-cursor: (mouse_mode_full == MouseModeFull.select) ? crosshair : (mouse_mode_full == MouseModeFull.drag && self.pressed && zoom_scale > 1.0) ? grabbing : (mouse_mode_full == MouseModeFull.drag && zoom_scale > 1.0) ? grab : default;

    property <length> start_drag_x;
    property <length> start_drag_y;
    property <length> start_img_x;
    property <length> start_img_y;

    property <bool> is_selecting: mouse_mode_full == MouseModeFull.select && self.pressed;
    property <length> selection_x;
    property <length> selection_y;
    property <length> selection_width;
    property <length> selection_height;

    coords_timer := Timer {
        interval: 60ms;
        running: root.timer_running;
        triggered => {
            if (root.mouse-x != root.last_coords_x || root.mouse-y != root.last_coords_y) {
                root.last_coords_x = root.mouse-x;
                root.last_coords_y = root.mouse-y;
                let win_w = root.width;
                let win_h = root.height;
                let img_w = root.current_image.width;
                let img_h = root.current_image.height;

                if (img_w > 0 && img_h > 0) {
                    let scale = Math.min(win_w / img_w, win_h / img_h);
                    let off_x = (win_w - img_w * scale) / 2;
                    let off_y = (win_h - img_h * scale) / 2;
                    let x = clamp(Math.round((root.last_coords_x - off_x) / scale), 0, img_w);
                    let y = clamp(Math.round((root.last_coords_y - off_y) / scale), 0, img_h);

                    root.display_coords = x + "," + y;
                }
            }
        }
    }

    public function toggle_mouse_mode() {
        mouse_mode_full = mouse_mode_full == MouseModeFull.drag ? MouseModeFull.select : MouseModeFull.drag;
    }

    public function reset_zoom() {
        zoom_scale = 1;
        img.width = root.width;
        img.height = root.height;
        img.x = 0;
        img.y = 0;
    }

    function zoom(scale_delta: float, center_x: length, center_y: length) {
        let old_scale = zoom_scale;
        let new_scale = clamp(zoom_scale * scale_delta, 1, 10.0);

        if (old_scale == new_scale) {
            return;
        }
        zoom_scale = new_scale;
        let ratio = new_scale / old_scale;

        if (img.width == 0px || img.width == root.width) {
            img.width = rect_img.width;
            img.height = rect_img.height;
            img.x = 0px;
            img.y = 0px;
        }
        img.width = img.width * ratio;
        img.height = img.height * ratio;
        img.x = center_x - (center_x - img.x) * ratio;
        img.y = center_y - (center_y - img.y) * ratio;
    }

    function zoom_to_selection() {
        let scale_x = root.width / selection_width;
        let scale_y = root.height / selection_height;
        let zoom_factor = Math.min(scale_x, scale_y);

        let center_x = selection_x + selection_width / 2;
        let center_y = selection_y + selection_height / 2;

        zoom(zoom_factor, center_x, center_y);

        selection_width = 0px;
        selection_height = 0px;
    }

    pointer-event(event) => {
        if (event.button == PointerEventButton.left) {
            if (event.kind == PointerEventKind.down) {
                root.start_drag_x = root.mouse-x;
                root.start_drag_y = root.mouse-y;
                root.start_img_x = img.x;
                root.start_img_y = img.y;
                if (mouse_mode_full == MouseModeFull.select) {
                    selection_width = 0px;
                    selection_height = 0px;
                }
            } else if (event.kind == PointerEventKind.up && mouse_mode_full == MouseModeFull.select) {
                if (selection_width > 5px && selection_height > 5px) {
                    zoom_to_selection();
                }
            }
        }
    }

    moved => {
        if (mouse_mode_full == MouseModeFull.drag && root.pressed && zoom_scale > 1.0) {
            img.x = root.start_img_x + (root.mouse-x - root.start_drag_x);
            img.y = root.start_img_y + (root.mouse-y - root.start_drag_y);
        }
        if (is_selecting) {
            selection_x = Math.min(root.mouse-x, root.start_drag_x);
            selection_y = Math.min(root.mouse-y, root.start_drag_y);
            selection_width = Math.abs(root.mouse-x - root.start_drag_x);
            selection_height = Math.abs(root.mouse-y - root.start_drag_y);
        }
    }

    scroll-event(event) => {
        let delta_up = event.delta-y > 0;
        if (event.modifiers.control) {
            zoom(delta_up ? 1.1 : 0.9, root.mouse-x, root.mouse-y);
        } else {
            reset_zoom();
            if (delta_up) {
                root.request_prev_image();
            } else {
                root.request_next_image();
            }
        }
        accept
    }

    double-clicked => {
        root.exit_full_view();
        reset_zoom();
    }

    rect_img := Rectangle {
        img := Image {
            source: root.current_image;
            image-fit: contain;
            width: 100%;
            height: 100%;
            x: 0px;
            y: 0px;
        }

        Rectangle {
            height: 16px;
            y: parent.height - self.height;
            width: 100%;
            background: Theme.overlay;
            Text {
                x: 5px;
                color: Theme.text-main;
                text: (curr_image_index + 1) + "/" + root.total_images;
            }

            Text {
                color: Theme.text-main;
                horizontal-alignment: center;
                vertical-alignment: center;
                text: curr_image_name;
            }

            Text {
                x: parent.width - self.width - 5px;
                color: Theme.text-main;
                text: "[x,y]=[" + display_coords + "]";
            }
        }

        Rectangle {
            x: root.selection_x;
            y: root.selection_y;
            width: root.selection_width;
            height: root.selection_height;
            visible: root.is_selecting || (root.selection_width > 0px && mouse_mode_full == MouseModeFull.select);
            background: Theme.primary-semi;
            border-color: Theme.primary;
            border-width: 1px;
        }

        ContextMenuArea {
            Menu {
                MenuItem {
                    title: @tr("Rotate +90");
                    activated => {
                        root.rotate_plus_90();
                    }
                }

                MenuItem {
                    title: @tr("Rotate -90");
                    activated => {
                        root.rotate_minus_90();
                    }
                }

                MenuItem {
                    title: @tr("Reset zoom");
                    activated => {
                        root.reset_zoom();
                    }
                }
            }
        }
    }

    changed height => {
        reset_zoom();
    }
    changed width => {
        reset_zoom();
    }
}
