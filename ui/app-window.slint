import { ScrollView } from "std-widgets.slint";

export struct GridItem {
  image: image,
  index: int,
}

export enum ViewMode {
    full,
    grid,
}

export component MainWindow inherits Window {
    title: "Luminous";
    background: #000000;
    // width: 1920px;
    // height: 1080px;
    full-screen: self.is_fullscreen;

    callback request_grid_data(int);
    callback request_next_image();
    callback request_prev_image();
    callback image_selected(int);
    callback quit_app();

    in property <[GridItem]> grid_model;
    in property <image> full_view_image;
    in-out property <int> curr_image_index: 0;
    in-out property <ViewMode> view_mode: ViewMode.full;
    in-out property <bool> is_fullscreen: false;

    forward-focus: my-key-handler;
    my-key-handler := FocusScope {
        key-pressed(event) => {
            if (event.text == "q") {
                root.quit_app();
                return accept;
            }
            if (event.text == "f") {
                root.is_fullscreen = !root.is_fullscreen;
                return accept;
            }
            if (root.view-mode == ViewMode.full) {
                if (event.text == "h" || event.text == Key.LeftArrow) {
                    debug("LeftArrow or 'h' pressed: prev_image");
                    root.request_prev_image();
                } else if (event.text == "l" || event.text == Key.RightArrow) {
                    debug("RightArrow or 'l' pressed: next_image");
                    root.request_next_image();
                } else if (event.text == Key.Escape) {
                    debug("Esc key pressed: switching to grid mode");
                    root.view_mode = ViewMode.grid;
                }
            } else if (root.view-mode == ViewMode.grid) {
                if (event.text == Key.Escape) {
                    debug("Esc key pressed: switching to full mode");
                    root.view_mode = ViewMode.full;
                }
            }
            accept
        }
    }

    grid_view := ScrollView {
        visible: root.view-mode == ViewMode.grid;
        viewport-height: grid_container.height;

        grid_container := Rectangle {
            width: parent.width;
            property <length> item-w: 200px;
            property <length> item-h: 200px;
            property <length> gap: 0px;

            property <int> cols: max(1, floor(root.width / (item-w + gap)));
            property <int> rows: (root.grid_model.length + cols - 1) / cols;
            height: (rows * (item-h + gap)) + gap;

            for item[i] in root.grid_model: Rectangle {
                width: parent.item-w;
                height: parent.item-h;
                x: Math.mod(i, parent.cols) * (parent.item-w + parent.gap) + parent.gap;
                y: floor(i / parent.cols) * (parent.item-h + parent.gap) + parent.gap;

                clip: true;
                border-radius: 0px;
                Image {
                    source: item.image;
                    image-fit: cover;
                    width: 100%;
                    height: 100%;

                    init => {
                        root.request_grid_data(item.index);
                    }
                }

                TouchArea {
                    clicked => {
                        root.image_selected(item.index);
                        root.view_mode = ViewMode.full;
                    }
                }
            }
        }
    }

    full_view := VerticalLayout {
        visible: root.view-mode == ViewMode.full;
        width: 100%;
        height: 100%;
        TouchArea {
            width: 100%;
            height: 100%;

            scroll-event(event) => {
                if (event.delta-y > 0) {
                    root.request_prev_image();
                } else if (event.delta-y < 0) {
                    root.request_next_image();
                }
                accept
            }

            Image {
                source: root.full_view_image;
                image-fit: contain;
                width: 100%;
                height: 100%;
            }
        }
    }
}
