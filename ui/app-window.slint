import { GridView, GridItem, MouseModeGrid } from "grid-view.slint";
import { FullView, MouseModeFull } from "full-view.slint";

export enum ViewMode {
    full,
    grid,
}

export { GridItem } from "grid-view.slint";

export component MainWindow inherits Window {
    title: "Luminous";
    background: app_background;
    preferred-width: 1280px;
    preferred-height: 720px;
    full-screen: self.is_fullscreen;

    // Bindings
    in property <string> bind_quit;
    in property <string> bind_fullscreen;
    in property <string> bind_switch_view_mode;
    in property <string> bind_reset_zoom;
    in property <string> bind_grid_pg_dn;
    in property <string> bind_grid_pg_up;
    in property <string> bind_switch_mouse_mode;

    // Full view Callbacks
    callback request_next_image();
    callback request_prev_image();
    callback rotate_plus_90();
    callback rotate_minus_90();

    // Grid view Callbacks
    callback request_grid_data(int, int);
    callback image_selected(int);
    callback bucket_resolution_changed(int);
    callback search_submitted(string);
    callback toggle_select_all(bool);

    // App Callbacks
    callback quit_app();

    // State
    in property <color> app_background: #000000;
    in property <[GridItem]> grid_model;
    in property <image> full_view_image;
    in-out property <int> curr_image_index: 0;
    in property <string> curr_image_name;
    in-out property <ViewMode> view_mode: ViewMode.grid;
    in-out property <bool> is_fullscreen: false;
    in-out property <int> grid_cols: 5;

    public function return_focus() {
        key-handler.focus();
    }
    forward-focus: key-handler;
    key-handler := FocusScope {
        key-pressed(event) => {
            if (event.text == root.bind_quit) {
                root.quit_app();
                return accept;
            }
            if (event.text == root.bind_fullscreen) {
                root.is_fullscreen = !root.is_fullscreen;
                return accept;
            }
            if (event.text == root.bind_switch_view_mode) {
                root.view_mode = root.view_mode == ViewMode.full ? ViewMode.grid : ViewMode.full;
                full_ui.reset_zoom();
                return accept;
            }
            if (root.view_mode == ViewMode.full) {
                if (event.text == "h" || event.text == Key.LeftArrow) {
                    full_ui.reset_zoom();
                    root.request_prev_image();
                    return accept;
                }
                if (event.text == "l" || event.text == Key.RightArrow) {
                    full_ui.reset_zoom();
                    root.request_next_image();
                    return accept;
                }
                if (event.text == root.bind_reset_zoom) {
                    full_ui.reset_zoom();
                    return accept;
                }
                if (event.text == root.bind_switch_mouse_mode) {
                    full_ui.toggle_mouse_mode();
                    return accept;
                }
            } else if (root.view_mode == ViewMode.grid) {
                if (event.text == root.bind_grid_pg_dn) {
                    grid_ui.page_down();
                    return accept;
                }
                if (event.text == root.bind_grid_pg_up) {
                    grid_ui.page_up();
                    return accept;
                }
                if (event.text == root.bind_switch_mouse_mode) {
                    grid_ui.toggle_mouse_mode();
                    return accept;
                }
                if (event.text == "/") {
                    grid_ui.focus_search();
                    return accept;
                }
            }
            reject
        }
    }

    grid_ui := GridView {
        visible: root.view_mode == ViewMode.grid;
        model: root.grid_model;
        grid_cols: root.grid_cols;
        forward-focus: key-handler;

        request_grid_data(start, count) => {
            root.request_grid_data(start, count);
        }
        bucket_resolution_changed(res) => {
            root.bucket_resolution_changed(res);
        }
        image_selected(idx) => {
            root.image_selected(idx);
            root.view_mode = ViewMode.full;
        }
        search_submitted(query) => {
            root.search_submitted(query);
            root.return_focus();
        }
        toggle_select_all(select) => {
            root.toggle_select_all(select);
        }
    }

    full_ui := FullView {
        visible: root.view_mode == ViewMode.full;
        timer_running: root.view_mode == ViewMode.full;
        current_image: root.full_view_image;
        curr_image_index: root.curr_image_index;
        curr_image_name: root.curr_image_name;
        total_images: root.grid_model.length;

        request_next_image => {
            root.request_next_image();
        }
        request_prev_image => {
            root.request_prev_image();
        }
        rotate_plus_90 => {
            root.rotate_plus_90();
        }
        rotate_minus_90 => {
            root.rotate_minus_90();
        }
        exit_full_view => {
            root.view_mode = ViewMode.grid;
        }
    }
}
